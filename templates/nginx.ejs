user www-data;
worker_processes 4;
pid /run/nginx.pid;

events {
  worker_connections 768;
  # multi_accept on;
}

http {<% for (var k in services) { %>
  upstream <%= k %> { <% if (services[k].lbmode && services[k].lbmode !== 'round_robin') { %>
    <%= services[k].lbmode %><% } %>
    <% services[k].nodes.forEach(function (node) { %>server <%= node.address %>:<%= node.port %>; <% }); %>
  }<% } %>

  server {
    listen <%= port %>;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    <% if (forcessl) { %>rewrite ^(.*) https://$host$1 permanent;
    <% } else { for (var k in services) { %>
    include /etc/nginx/services/<%= k %>.conf;<% } %>
    <% } %>
  }
  <% if (ssl) { %>
  server {
    listen 443;

    include ssl.conf
    <% for (var k in services) { %>
    include /etc/nginx/services/<%= k %>.conf;<% } %>
  }
  <% } %>
}